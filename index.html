<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>game</title>
</head>
<div id="gameView"></div>
<table>
    <tr>
        <td>名字</td>
        <td id="name"></td>
    </tr>
    <tr>
        <td>裝備</td>
        <td id="equip"></td>
    </tr>
    <tr>
        <td>attack count</td>
        <td id="attack_count"></td>
    </tr>
</table>
<div id="e_move">Enemy Move</div>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="js/pixi.js/bin/pixi.min.js"></script>
<script src="js/datas.js"></script>
<script src="js/core.js"></script>
<script src="js/attack_model.js"></script>
<script>
var tempLanguageCombination; //語言組合

window.addEventListener('keydown', languageCombination);

var arrTimer = new Array(); //時間倒數物件
var arrRoleObj = new Array(); //角色物件
var arrDoorsDisplayObj = new Array(); //門物件


var totalRoom = 0; //總房間數

var currentRole; //目前操作的腳色
var attackButtom = new Array();

var attackMode = false;
//block size
var blockWidth = 200;
var blockHeight = 200;
var t = 0;


var displayWidth = 600;
var displayHeight = 600;

// create the root of the scene graph
var stage;
var renderer;
//增加容器
var mapContainer;
var mapTexture = PIXI.Texture.fromImage('images/tilemap.png');
var cameraFollow = true;
init();




/*
var t2 = new countdown();
t2.process = function(){
    console.log(this.percent);
}

arrTimer.push(t2);

*/



function init() {

    stage = new PIXI.Container();

    renderer = PIXI.autoDetectRenderer(displayWidth, displayHeight, {
        backgroundColor: 0x1099bb
    });

    document.getElementById("gameView").appendChild(renderer.view);

    //增加容器
    mapContainer = new PIXI.Container();
    createMap();

    var cR = new createRole();
    cR._roleTypeObj = arrRoleType[0];
    cR._faction = "enemy";
    for (var i = 0; i < 40; i++) {
        cR._roleLocal = null;
        var _enemy = cR.create();
        _enemy.visible = false;
    }

    var cR = new createRole();
    cR._roleTypeObj = arrRoleType[1];
    cR._faction = "player";
    cR._roleLocal = getMapInfo(arrMap, {
        room_id: "f"
    })[0];
    var newR = cR.create();



    newR.interactive = true;
    newR.buttonMode = true;

    newR.skill = [];
    newR.equip = {
        main: [0, 1],
        sub: []
    };
    //取得視野
    var _currentPanorama = getPanorama(newR.local.room_id, 0, 5);

    for (var i = 0; i < _currentPanorama.length; i++) {
       
        objectHelp(arrRoleObj, {
            faction: "enemy",
            local:_currentPanorama[i]
        }, {
            visible: true
        });

    }


    console.log(newR.getBounds());

    

    var getInitCurrentPlayer = objectHelp(arrRoleObj, {
        faction: "player"
    })[0];
    moveToTarget(getInitCurrentPlayer.x, getInitCurrentPlayer.y);

    /*
         var cR = new createRole();
        cR._roleTypeObj = arrRoleType[1];
        cR._faction = "player";
        cR._roleLocal = "q";
        var newR = cR.create();
    */
    /*newR.oX = newR.position.x;
    newR.oY = newR.position.y;
    newR.at = 2000;
    newR.endTime = new Date().getTime() + newR.at;

    newR.startTime = new Date().getTime();*/

    /* var aass =findEnemyByNoise();
     console.log(aass);*/


    $('#e_move').click(function() {
        enemyMove();
    })

    newR.on('mousedown', roleClick);

    //enemyMove();

    mapContainer.on('mousedown', onDragStart)
        .on('touchstart', onDragStart)
        // events for drag end
        .on('mouseup', onDragEnd)
        .on('mouseupoutside', onDragEnd)
        .on('touchend', onDragEnd)
        .on('touchendoutside', onDragEnd)
        // events for drag move
        .on('mousemove', onDragMove)
        .on('touchmove', onDragMove);

    animate();
}

stage.addChild(mapContainer);

// アニメーション関数を定義する
function animate() {
    requestAnimFrame(animate);
    renderer.render(stage);

    /*  tilingSprite.tilePosition.x += 1;
      tilingSprite.tilePosition.y += 1;*/

    for (var i = 0; i < arrTimer.length; i++) {
        //console.log(arrTimer.length);
        if (arrTimer[i].play()) {
            arrTimer.splice(i, 1);
        }

    }

    for (var i = 0; i < arrRoleObj.length; i++) {


        if (arrRoleObj[i].actionMovement == true) {

            //var _de = (new Date().getTime() - arrRoleObj[i].startTime) / arrRoleObj[i].at * 100;

            var _speed = 5;

            var _dy = arrRoleObj[i].goalY - arrRoleObj[i].position.y;
            var _dx = arrRoleObj[i].goalX - arrRoleObj[i].position.x;

            var _radian = Math.atan2(_dy, _dx);


            if (Math.sqrt(_dy * _dy + _dx * _dx) < _speed) {
                arrRoleObj[i].position.x = arrRoleObj[i].goalX;
                arrRoleObj[i].position.y = arrRoleObj[i].goalY;
                arrRoleObj[i].actionMovement = false;
            } else {
                arrRoleObj[i].position.x += Math.cos(_radian) * _speed;
                arrRoleObj[i].position.y += Math.sin(_radian) * _speed;
            }


        }



        /*  var _rotation = Math.atan2(arrRoleObj[i].position.y - arrRoleObj[i].goalY, arrRoleObj[i].position.x - arrRoleObj[i].goalX);
          console.log(Math.cos(_rotation));*/
        // Move towards the player
        /* arrRoleObj[i].position.x += Math.cos(_rotation);
         arrRoleObj[i].position.y += Math.sin(_rotation);*/
    }

    if (mapContainer.actionMovement == true) {
        var _speed = 5;

        var _dy = mapContainer.goalY - mapContainer.position.y;
        var _dx = mapContainer.goalX - mapContainer.position.x;

        var _radian = Math.atan2(_dy, _dx);


        if (Math.sqrt(_dy * _dy + _dx * _dx) < _speed) {
            mapContainer.position.x = mapContainer.goalX;
            mapContainer.position.y = mapContainer.goalY;
            mapContainer.actionMovement = false;
        } else {
            mapContainer.position.x += Math.cos(_radian) * _speed;
            mapContainer.position.y += Math.sin(_radian) * _speed;
        }

    }


}



//以後參考
//graphics.hitTest = graphics.getBounds();
</script>
</body>

</html>
